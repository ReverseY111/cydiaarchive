#!/bin/sh
FW=3
REBOOT=
IMAGENT=
NOAPP=
ROUNDED_ICON=
if [ -d /System/Library/Frameworks/SpriteKit.framework ] 
then
    FW=7
    IMAGENT=YES
    NOAPP=YES
elif [ -d /System/Library/PrivateFrameworks/BackBoardServices.framework ] 
then
    FW=6
    REBOOT=YES
    IMAGENT=YES
    ROUNDED_ICON=YES
elif [ -f /System/Library/LaunchDaemons/com.apple.imagent.plist ] 
then
    FW=5
    IMAGENT=YES
    ROUNDED_ICON=YES
elif [ -d /System/Library/Frameworks/CoreTelephony.framework ]
then
    FW=4
fi
MS=/Library/MobileSubstrate/DynamicLibraries
WA=/Library/WeeLoader/Plugins/TextHeadsWeeApp.bundle
AD=/Applications/biteSMS.app

if [ "$REBOOT" ] 
then
    declare -a cydia
    cydia=($CYDIA)
    if [[ ${CYDIA+@} ]]; then
        eval "echo 'finish:reboot' >&${cydia[0]}"
    else
        echo "Please REBOOT your device"
    fi
fi

if [ "$IMAGENT" ] 
then
    mv ${MS}/biteIMAgentfw${FW}.plist ${MS}/biteIMAgent.plist
    mv ${MS}/biteIMAgentfw${FW}.dylib ${MS}/biteIMAgent.dylib
    launchctl stop com.apple.imagent
else
    rm -f ${MS}/biteIMAgent.*
fi

if [ "$NOAPP" ] 
then
    rm -f ${AD}/biteSMS ${AD}/biteSMS.sh
fi

if [ "$ROUNDED_ICON" ] 
then
    mv ${AD}/icon_rounded.png ${AD}/icon.png
    mv ${AD}/icon_rounded@2x.png ${AD}/icon@2x.png
fi

mv ${MS}/biteSMSsbfw${FW}.plist ${MS}/biteSMSsb.plist
mv ${MS}/biteSBarClientfw${FW}.dylib ${MS}/biteSBarClient.dylib
mv ${MS}/biteSBarClientfw${FW}.plist ${MS}/biteSBarClient.plist
[ -f "${AD}/Infofw${FW}.plist" ] && mv "${AD}/Infofw${FW}.plist" "${AD}/Info.plist"
rm -f ${MS}/biteSMSsbfw*.plist
rm -f ${MS}/biteIMAgentfw*.*
rm -f ${MS}/biteSBarClientfw*.*
rm -fr /var/mobile/Library/biteSMS.themes
chmod a+r ${MS}/bite*.*
chmod a+x ${MS}/bite*.dylib
[ -d "${WA}" ] && chmod a+rx ${WA} ${WA}/*.lproj ${WA}/TextHeadsWeeApp
[ -d "${WA}" ] && chmod a+r ${WA}/*

exit 0
